import asyncio

from langchain_core.output_parsers import JsonOutputParser
from pydantic import BaseModel, Field
from datetime import datetime
from tenacity import retry, stop_after_attempt, wait_exponential_jitter, before_log, after_log, before_sleep_log
from src.tools.esg_indicator import invoke_with_retry



esg_report_framework = {
    # 第一部分：开篇与管治（固定章节）
    "标题： 董事会声明": {
        "内容指引": "综述董事会对ESG事宜的最高监管权责，体现董事会对可持续发展的最终责任。包括其参与重大性议题评估的确认，以及对年度ESG目标进度的整体检视结论"
    },
    "标题： 管理层致辞": {
        "内容指引": "由董事会主席或CEO阐述对可持续发展的顶层承诺、本年度ESG工作的核心亮点，以及对利益相关方的回应与未来展望。"
    },
    "标题： 关于#企业#": {
        "内容指引": "简述#企业#的业务概况、核心产品/服务、运营规模、使命愿景，企业文化、年度荣誉等，以及年度综合ESG亮点绩效（按照“环境”、“社会”、“管治”，三个板块进行划分）。",
    },

    # 第二部分：ESG专题表现（正文，顺序和标题需灵活调整）
    "标题： 可持续发展管理": {
        "内容指引": "描述#企业#的ESG管治架构（董事会、ESG委员会/工作组）、重大性议题评估过程与结果、以及利益相关方沟通机制。标题需要专注在章节标题方面，不要超过这个范围。"
    },
    "标题： [环境章节]": {
        "内容指引": "描述#企业#在应对气候变化、资源使用（能源、水）、排放物管理、绿色运营（如绿色数据中心、绿色办公、绿色制造）方面的举措和绩效。标题需要专注在章节标题方面，不要超过这个范围。"
    },
    "标题： [产品/客户章节]": {
        "内容指引": "描述#企业#如何确保产品/服务的质量、安全、可靠性。对于科技/数据公司，重点是数据安全、用户隐私保护、负责任的AI伦理。对于制造/消费品公司，重点是供应链管理、客户健康与安全。标题需要专注在章节标题方面，不要超过这个范围。",
    },
    "标题： [员工章节]": {
        "内容指引": "描述#企业#的人才战略、员工发展与培训、健康与安全保障、多元化与包容性（DEI）以及员工福祉。标题需要专注在章节标题方面，不要超过这个范围。",
    },
    "标题： [社区章节]": {
        "内容指引": "描述#企业#的社会贡献战略、公益项目、员工志愿服务，以及如何利用核心业务来创造社会价值（如科技普惠、支持创新创业、赋能中小企业）。标题需要专注在章节标题方面，不要超过这个范围。",
    },
    "标题： [商业道德章节]": {
        "内容指引": "描述#企业#在反贪腐、反垄断、反洗钱、供应链管理等商业道德相关议题上的管理举措和成效。标题需要专注在章节标题方面，不要超过这个范围。",
    },
    # 第三部分：附录与声明（固定章节）
    "标题： ESG表现绩效": {
        "内容指引": "一个或多个数据表格，汇总报告期内关键的ESG量化指标（KPIs），并对照主流标准（如GRI、港交所ESG指引等）进行索引。",
    },
    "标题： 关于本报告": {
        "内容指引": "报告的编制基准、报告范围（时间、地域、业务）、数据保证（如是否经第三方鉴证）及联系方式。",
    }
}

esg_report_framework_titles = [
    '1. 董事会声明',
    '2. 管理层致辞',
    '3. 关于#企业#',
    '4. 可持续发展管理',
    '5. [环境章节]',
    '6. [产品/客户章节]',
    '7. [员工章节]',
    '8. [社区章节]',
    '9. [商业道德章节]',
    '10. ESG表现绩效',
    '11. 关于本报告'
]

class TitleInFramework(BaseModel):
    title: str = Field(..., description="正文标题")
    title_in_framework: str =  Field(..., description="对应在正文框架中的标题")

async def title_framework(title, children_title, topic_info_rules):
    """
    生成ESG报告框架
    """
    # 获取当前年份
    current_year = datetime.now().year

    system_prompt = f"""
    角色定义： 你是ESG经理。
    历史报告标题：{title}
    历史报告副标题：{children_title}
    历史报告标题对应正文总结和填写指导：{topic_info_rules}
    正文框架：{esg_report_framework}

    核心任务： 基于对#企业#历史报告标题”{title}“以及副标题”{children_title}“以及标题与副标题下属的对应正文总结和填写指导”{topic_info_rules}“的理解，判断属于正文框架{esg_report_framework}的哪部分的标题。

    你需要严格根据正文框架里的内容指引，判断历史报告标题与哪个正文框架标题最接近，输出最接近的正文框架标题，即”标题：“后的文字内容。
    """

    parser = JsonOutputParser(pydantic_object=TitleInFramework)
    format_instructions = parser.get_format_instructions()

    user_prompt = f"""输出格式要求：{format_instructions}"""

    messages = [{"role": "system", "content": system_prompt}, {"role": "user", "content": user_prompt}]

    result = await invoke_with_retry(messages=messages, parser=parser)
    return result


async def main():
    title_raw = [{'title_id': 1, 'title': '关于本报告', 'parent_id': 0, 'topic_info_rules': '请提供公司关于环境、社会及治理（ESG）相关议题的披露政策与报告机制，包括但不限于：（1）报告编制依据；（2）报告范围（涵盖的组织和时间范围）；（3）数据来源及统计口径；（4）报告编制遵循的原则（如重要性、量化、平衡、一致性等）；（5）信息可靠性保障措施；（6）报告获取方式及反馈渠道。'}, {'title_id': 2, 'title': '董事会声明', 'parent_id': 0, 'topic_info_rules': '请提供公司董事会在治理架构、战略制定及监督方面的相关措施，包括但不限于：（1）董事会的职责与权力范围；（2）董事会下设委员会的职能及运作机制；（3）董事会在可持续发展战略中的角色与参与方式；（4）董事会如何将关键绩效指标纳入管理层考核体系；（5）董事会对重要性议题评估及风险管理体系的监督机制。'}, {'title_id': 3, 'title': '主席寄语', 'parent_id': 0, 'topic_info_rules': '请提供公司在数字技术与绿色化结合方面的具体措施，包括但不限于：（1）数字化工具在节能减排中的应用；（2）产品中融入的绿色设计理念；（3）在供应链管理中减少碳足迹的策略；（4）是否设立专门的绿色技术研发部门或机制；（5）相关成果数据及案例。'}, {'title_id': 4, 'title': '关于金蝶国际', 'parent_id': 0, 'topic_info_rules': '请提供公司有关提升雇员履行工作职责的知识及技能，以及员工职业发展与晋升方面的政策/制度/声明。若无法提供相关文件附件，则请提供以下信息：（1）政策名称；（2）覆盖范围；（3）政策主要内容；（4）政策文件是否有修订，如有，请说明主要修订内容；（5）政策是否公开。'}, {'title_id': 5, 'title': '集团简介', 'parent_id': 4, 'topic_info_rules': '请提供公司当前的战略方向、核心业务领域及市场定位，包括但不限于以下内容：（1）公司的主要业务板块及产品线；（2）重点发展的技术或服务领域；（3）市场目标及竞争优势；（4）未来发展规划及战略布局。'}, {'title_id': 6, 'title': '企业文化', 'parent_id': 4, 'topic_info_rules': '请提供公司关于企业文化的定义、核心价值观及经营哲学的相关信息。具体包括：（1）企业文化的核心内容；（2）核心价值观的具体表述及其内涵；（3）企业哲学或经营理念的说明；（4）企业文化在日常运营中的体现方式；（5）是否有相关制度文件或公开声明，如有，请提供文件名称及主要内容。'}, {'title_id': 7, 'title': '业务运营布局', 'parent_id': 4, 'topic_info_rules': '请介绍公司在全球范围内的业务运营布局，包括研发中心、分支机构及合作伙伴的数量和分布情况。同时，请说明公司如何构建信任、开放、共赢的生态体系，以及在各行业的深入程度和赋能企业数字化转型的具体措施。'}, {'title_id': 8, 'title': '年度关键绩效', 'parent_id': 4, 'topic_info_rules': '请提供公司在环境管理方面的关键绩效数据，包括但不限于：（1）用水强度、耗电强度及温室气体排放强度的年度变化情况；（2）深圳园区因减排举措直接减少的温室气体排放量，涵盖范围一、范围二和范围三的排放数据。'}, {'title_id': 9, 'title': '完善企业管治夯实可持续发展根基', 'parent_id': 0, 'topic_info_rules': '请提供公司为实现治理效能提升及可持续发展目标所采取的措施，包括但不限于：（1）公司治理体系的构建情况；（2）全面风险防控机制的具体内容；（3）商业道德管理的实施方式及标准；（4）如何将可持续发展理念融入企业价值观；（5）在治理过程中对股东、客户、员工及社会等利益相关方的考量与行动。'}, {'title_id': 10, 'title': '可持续发展管理', 'parent_id': 9, 'topic_info_rules': '请提供公司可持续发展治理架构的详细信息，包括：（1）治理层级结构（如董事会、委员会等）；（2）各层级职责划分；（3）可持续发展相关决策机制；（4）是否设有专门的可持续发展委员会或负责人；（5）治理架构如何确保环境、社会及管治（ESG）因素在业务决策和运营中的有效融入。'}, {'title_id': 11, 'title': '规范公司治理', 'parent_id': 9, 'topic_info_rules': '请提供公司治理架构的设立情况及董事会相关委员会的职责分工，包括：（1）董事会下设委员会名称及其主要职能；（2）董事会及各专门委员会的会议召开频率及决策机制；（3）董事会成员的构成情况，包括独立非执行董事的持股、关联关系及履职情况；（4）董事会多元化政策的制定及实施情况，包括性别、年龄、国籍、专业背景等维度的考量；（5）董事会技能矩阵评估工具的应用情况及优化措施。'}, {'title_id': 12, 'title': '全面风险管理', 'parent_id': 9, 'topic_info_rules': '请介绍公司为建立并持续优化全面风险管理体系所采取的措施，包括但不限于以下内容：（1）风险管理架构设计及职责划分；（2）风险管理流程覆盖范围及关键环节；（3）风险识别、评估与应对机制；（4）新兴风险的识别与管理策略；（5）风险管理文化培育措施；（6）风险管理培训与能力提升计划；（7）风险管理相关制度文件或政策声明。'}, {'title_id': 13, 'title': '商业道德与诚信', 'parent_id': 9, 'topic_info_rules': '请提供公司有关商业道德与诚信管理的制度文件、执行机制及监督措施，包括但不限于以下内容：（1）商业道德相关制度文件名称及覆盖范围（2）制度文件主要内容及修订情况（3）商业道德风险管理体系及审计机制（4）举报渠道及处理流程说明（5）举报人保护机制及保密措施（6）供应商廉洁管理政策及实施情况（7）商业道德培训计划及开展情况（8）阳光合作承诺书等合规条款内容'}, {'title_id': 14, 'title': '以客户为中心长期坚持专业主义', 'parent_id': 0, 'topic_info_rules': '请提供公司围绕‘以客户为中心’理念，在产品与服务交付中落实可持续发展、信息安全、隐私保护、客户服务优化及供应链管理等方面的政策、措施和实践情况。具体包括：（1）相关理念或战略声明；（2）在产品质量控制、研发创新、信息安全与隐私保护方面的具体举措；（3）提升客户体验和服务质量的机制与工具；（4）供应链可持续管理的相关政策或合作模式；（5）是否有相关信息披露或第三方认证。'}, {'title_id': 15, 'title': '世界一流的产品', 'parent_id': 14, 'topic_info_rules': '请提供公司有关产品全生命周期质量管理、质量审核机制、质量管理体系认证及质量文化建设的相关信息。具体包括：（1）质量管理体系的架构和运行机制（2）质量审核的频率、范围及实施方式（3）已获得的质量管理体系认证及证书有效性情况（4）质量文化建设的具体措施及成效（5）质量事件处理流程及改进机制'}, {'title_id': 16, 'title': '世界一流的服务', 'parent_id': 14, 'topic_info_rules': '请提供公司关于客户服务体系的建设情况及服务机制的详细信息，包括但不限于以下内容：（1）客户服务体系的组成及各渠道的功能说明；（2）客户服务流程的分级分类处理机制；（3）客户投诉处理制度及流程；（4）客户信息安全保护措施及具体操作规范；（5）客户满意度提升措施及评价体系。'}, {'title_id': 17, 'title': '世界一流的交付', 'parent_id': 14, 'topic_info_rules': '请介绍公司在项目交付过程中为确保质量与客户满意度所采取的措施及制度安排。具体包括：（1）项目交付的关键阶段（如需求分析、蓝图设计、测试、上线、验收等）；（2）制定的系统化指导原则与质量标准；（3）文化引导与制度约束的具体措施；（4）相关制度文件或政策说明；（5）是否有定期评估或改进机制，如有，请提供相关信息。'}, {'title_id': 18, 'title': '世界一流的生态', 'parent_id': 14, 'topic_info_rules': '请介绍公司在构建和维护生态合作伙伴体系方面的政策、措施及成效，包括但不限于以下信息：（1）生态合作的总体战略及目标；（2）生态伙伴的分类与管理机制；（3）引入战略级伙伴及国际业务伙伴的情况；（4）与高校、行业协会等机构的合作成果；（5）生态赋能活动的开展情况及效果；（6）生态合作对客户数字化转型的支持作用。'}, {'title_id': 19, 'title': '世界一流的口碑', 'parent_id': 14, 'topic_info_rules': '请提供公司为支持中小企业数字化转型所采取的具体措施与政策，包括但不限于：（1）数字化培训计划及实施情况；（2）上云补贴政策及相关发放情况；（3）数字化解决方案的类型与应用场景；（4）与政府、协会及其他机构的合作情况；（5）相关活动的覆盖范围与参与人数。'}, {'title_id': 20, 'title': '以奋斗者为本长期坚持明心净心', 'parent_id': 0, 'topic_info_rules': '请提供公司为保障员工合法权益、健康安全及福祉所采取的具体措施和政策，包括但不限于：（1）员工权益保障制度或声明；（2）员工健康与安全相关政策；（3）员工福利体系介绍；（4）员工心理健康支持措施；（5）员工权益保障的执行情况与成效。'}, {'title_id': 21, 'title': '参与社区公益', 'parent_id': 20, 'topic_info_rules': '请提供公司参与社区公益活动的具体情况，包括但不限于以下信息：（1）公益项目名称及内容；（2）公益项目的受益对象及范围；（3）公益活动的开展时间及频率；（4）员工参与公益的方式及比例；（5）公益项目与公司ESG战略的关联性；（6）是否有相关成果或数据支持（如捐赠金额、服务时长、受益人数等）。'}, {'title_id': 22, 'title': '公平多元和包容的工作环境', 'parent_id': 20, 'topic_info_rules': '请提供公司为实现招聘与职场环境的公平性、多元化及包容性所采取的具体措施，包括但不限于以下信息：（1）平等雇佣政策及实施机制；（2）职场歧视与骚扰的举报渠道及处理流程；（3）针对女性员工及特殊群体（如残障人士、外籍员工等）的权益保障措施；（4）多元化团队建设策略及成果；（5）相关制度文件或公开声明的名称、内容及覆盖范围。'}, {'title_id': 23, 'title': '员工权益保障', 'parent_id': 20, 'topic_info_rules': '请提供公司为保障员工合法权益所采取的具体措施，包括但不限于以下信息：（1）相关法律法规及政策制度的名称与内容；（2）劳动用工管理规范及执行情况；（3）人权保护相关政策、承诺声明及实施机制；（4）员工申诉与举报渠道及处理流程；（5）员工权益保护的案例或活动说明；（6）是否建立工会或员工委员会等民主管理组织及其职能。'}, {'title_id': 24, 'title': '员工培养与发展', 'parent_id': 20, 'topic_info_rules': '请提供公司有关提升雇员履行工作职责的知识及技能，以及员工职业发展与晋升方面的政策/制度/声明。若无法提供相关文件附件，则请提供以下信息：（1）政策名称；（2）覆盖范围；（3）政策主要内容；（4）政策文件是否有修订，如有，请说明主要修订内容；（5）政策是否公开。'}, {'title_id': 25, 'title': '员工福利与关怀', 'parent_id': 20, 'topic_info_rules': '请提供公司有关员工福利政策、沟通机制、满意度调查、民主参与、工作生活平衡及企业文化建设等方面的制度或具体措施。若无法提供相关文件附件，则请提供以下信息：（1）政策名称；（2）覆盖范围；（3）政策主要内容；（4）政策是否公开；（5）是否有定期评估或优化机制。'}, {'title_id': 26, 'title': '职业健康与安全', 'parent_id': 20, 'topic_info_rules': '请提供公司为保障员工职业健康与安全所建立的管理体系相关信息，包括：（1）体系名称及覆盖范围；（2）体系依据的标准或法律法规；（3）体系运行情况及认证状态；（4）组织架构与管理职责分工；（5）是否定期进行体系评估与改进。'}, {'title_id': 27, 'title': '建设自己修复与环境的关系', 'parent_id': 0, 'topic_info_rules': '请说明公司在运营过程中为降低对环境的依赖和影响所采取的具体措施，包括但不限于以下内容：（1）公司关于绿色运营的核心理念或战略声明；（2）在碳中和目标下的具体行动方案或实施路径；（3）清洁技术的研发与应用情况；（4）科技与自然和谐共生的相关实践案例；（5）是否制定并公开环境修复相关的政策或承诺。'}, {'title_id': 28, 'title': '完善环境管理', 'parent_id': 27, 'topic_info_rules': '请介绍公司为完善环境管理体系所采取的措施，包括但不限于：（1）环境政策与制度建设情况；（2）环境管理架构设置及责任落实机制；（3）环境管理体系认证与复审情况；（4）环境管理流程标准化和规范化改进措施；（5）环境管理体系的持续优化计划及实施效果。'}, {'title_id': 29, 'title': '应对气候变化', 'parent_id': 27, 'topic_info_rules': '请提供公司在应对气候变化方面的策略、治理结构、风险评估、低碳运营措施、产品与服务创新、供应链管理、碳排放目标及进展、温室气体排放数据等方面的信息。具体包括：（1）气候战略与治理架构，包括董事会及委员会的职责与监督机制；（2）气候相关风险与机遇的识别、评估及情景分析方法；（3）物理风险和转型风险的具体评估情况及应对措施；（4）提升能效、优化能源结构、推广可再生能源等低碳运营举措；（5）在清洁技术、低碳产品与服务方面的布局与成果；（6）气候风险管理流程，包括识别、评估、应对、监控与报告机制；（7）绿色采购政策及对供应商的碳排放管理要求；（8）碳减排目标设定、年度进展及达成情况；（9）温室气体排放数据，包括范围一、范围二和范围三的排放量及核算依据。'}, {'title_id': 30, 'title': '能源管理', 'parent_id': 27, 'topic_info_rules': '请提供公司有关能源管理的政策、制度及实施措施，包括但不限于以下信息：（1）能源管理相关制度名称；（2）能源管理覆盖范围；（3）能源管理目标及达成情况；（4）能源使用效率提升措施，如智能监控系统、设备节能改造等；（5）节能行动具体实施方式，如照明、空调、设备运行管理等；（6）是否开展员工节能培训或宣传活动；（7）是否有清洁技术投资与研发计划；（8）是否公开相关管理制度及年度能源管理报告。'}, {'title_id': 31, 'title': '水资源管理', 'parent_id': 27, 'topic_info_rules': '请提供公司关于水资源管理的政策、制度及实施措施，包括但不限于以下信息：（1）水资源管理制度名称及内容；（2）节水目标设定及达成情况；（3）节水设备使用情况及智能用水监测技术应用；（4）园区用水密度及能耗对比数据；（5）员工节水培训与宣传措施。'}, {'title_id': 32, 'title': '排放与废弃物管理', 'parent_id': 27, 'topic_info_rules': '请提供公司关于废弃物分类、收集、处置及回收利用的相关政策、制度或措施，包括但不限于：（1）废弃物分类管理制度；（2）废弃物处理流程及标准；（3）可回收物与有害废弃物的处理方式；（4）废弃物回收利用率目标及达成情况；（5）是否与专业废弃物处理机构合作；（6）是否有相关环境法规遵循情况说明。'}, {'title_id': 33, 'title': '绿色建筑', 'parent_id': 27, 'topic_info_rules': '请提供公司在建筑项目中落实绿色设计理念和措施的相关信息，包括但不限于：（1）绿色建筑认证情况；（2）使用的环保建材及节能技术；（3）建筑节能设计（如幕墙系统、自然通风、采光等）；（4）生态保育与环境恢复措施；（5）施工过程中的噪音、废水、废气及废弃物管理措施；（6）智慧资源管理系统（如能源、水资源监控）的实施情况；（7）空调、电梯等设备的节能性能及能效标准。'}]

    def build_lookup(data):
        """
        构建 2 个索引：
        1. title_id → 完整对象
        2. parent_id → children 列表
        """
        id_lookup = {item["title_id"]: item for item in data}

        parent_children_map = {}
        for item in data:
            parent_children_map.setdefault(item["parent_id"], []).append(item)

        return id_lookup, parent_children_map

    def collect_recursive(parent_id, parent_children_map):
        """
        递归搜集所有下级 title 与 rules（无限层级）
        返回：(所有标题 list, 所有规则 list)
        """
        collected_titles = []
        collected_rules = []

        for child in parent_children_map.get(parent_id, []):
            # 添加当前子节点
            collected_titles.append(child["title"])
            collected_rules.append(child["topic_info_rules"])

            # 递归收集：子 → 孙 → 曾孙...
            sub_titles, sub_rules = collect_recursive(child["title_id"], parent_children_map)
            collected_titles.extend(sub_titles)
            collected_rules.extend(sub_rules)

        return collected_titles, collected_rules

    def convert_flat_recursive(data):
        """
        返回多级目录拍平的结果：
        [
          {
            "title": "...",
            "children_title": [...扁平化所有子节点...],
            "topic_info_rules": [...扁平化所有规则...]
          }
        ]
        """
        id_lookup, parent_children_map = build_lookup(data)

        result = []
        top_nodes = parent_children_map.get(0, [])

        for top in top_nodes:
            # 顶层 title 自己的规则
            own_rule = top["topic_info_rules"]

            # 递归收集所有子孙层级
            c_titles, c_rules = collect_recursive(top["title_id"], parent_children_map)

            result.append({
                "title": top["title"],
                "children_title": c_titles,
                "topic_info_rules": [own_rule] + c_rules
            })

        return result

    title_list = convert_flat_recursive(title_raw)
    print(title_list)
    tasks = [asyncio.create_task(title_framework(title['title'], title['children_title'], title['topic_info_rules'])) for title in title_list]
    results = await asyncio.gather(*tasks)
    print(results)

if __name__ == '__main__':
    asyncio.run(main())